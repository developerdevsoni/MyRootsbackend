// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id        Int          @id @default(autoincrement())
  email     String       @unique
  password  String
  name      String?
  createdAt DateTime     @default(now())
  trees     FamilyTree[]
}

model FamilyTree {
  id             Int           @id @default(autoincrement())
  title          String
  userId         Int
  user           User          @relation(fields: [userId], references: [id])
  rootMemberId   Int?          @unique
  rootMember     FamilyMember? @relation("TreeRoot", fields: [rootMemberId], references: [id])
  members        FamilyMember[] @relation("TreeMembers")
  createdAt      DateTime      @default(now())
}

model FamilyMember {
  id              Int              @id @default(autoincrement())
  treeId          Int
  tree            FamilyTree       @relation("TreeMembers", fields: [treeId], references: [id])
  treeRootOf      FamilyTree?      @relation("TreeRoot")
  name            String
  gender          String           // "male", "female", "other"
  birthDate       DateTime?
  deathDate       DateTime?
  location        String?
  imageUrl        String?
  generationLevel Int              @default(0) // Kept for legacy/caching, but not source of truth
  createdAt       DateTime         @default(now())
  
  // New Explicit Relationships
  parents         ParentChild[]    @relation("Child")
  children        ParentChild[]    @relation("Parent")
  
  // Spouse Relations (Bidirectional in DB, but we strictly use FamilyRelation for this now)
  spouseRelationsFrom FamilyRelation[] @relation("SpouseFrom")
  spouseRelationsTo   FamilyRelation[] @relation("SpouseTo")
}

model ParentChild {
  id        Int          @id @default(autoincrement())
  childId   Int
  parentId  Int
  role      String       // "father", "mother", "parent"

  child     FamilyMember @relation("Child", fields: [childId], references: [id], onDelete: Cascade)
  parent    FamilyMember @relation("Parent", fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([childId, parentId])
}

model FamilyRelation {
  id              Int          @id @default(autoincrement())
  memberId        Int
  relatedMemberId Int
  relationType    String       // ONLY "spouse"
  startDate       DateTime?
  endDate         DateTime?    // For divorce/separation
  
  member          FamilyMember @relation("SpouseFrom", fields: [memberId], references: [id], onDelete: Cascade)
  relatedMember   FamilyMember @relation("SpouseTo", fields: [relatedMemberId], references: [id], onDelete: Cascade)

  @@unique([memberId, relatedMemberId])
}

model AncestorIndex {
  id              Int      @id @default(autoincrement())
  userId          Int
  treeId          Int
  memberId        Int      @unique
  normalizedName  String
  generationLevel Int
  birthYearApprox Int?
  location        String?
}

model AncestorMatch {
  id              Int      @id @default(autoincrement())
  memberAId       Int
  memberBId       Int
  treeAId         Int
  treeBId         Int
  confidenceScore Float
  createdAt       DateTime @default(now())
}
